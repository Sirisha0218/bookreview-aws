trigger:
  paths:
    include:
      - terraform/**
  branches:
    include:
      - main

# -------------------------
# Global Variables
# -------------------------
variables:
  - group: Terraform-AWS-Creds   # contains AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION
  - name: AWS_REGION
    value: "us-east-1"
  - name: EC2_KEYPAIR_NAME
    value: "ubuntu-key"

# -------------------------
# Stage: AWS Infrastructure
# -------------------------
stages:
- stage: AWSInfra
  displayName: 'Provision AWS Infrastructure'
  jobs:
  - job: Terraform_AWS
    displayName: 'Terraform Init & Apply (AWS)'
    pool:
      name: 'linux-hosted-agent-pool'

    steps:
    # -------------------------
    # Step 1: Install Terraform
    # -------------------------
    - script: |
        sudo apt-get update -y
        sudo apt-get install -y unzip curl
        TF_VERSION=1.9.5
        curl -fsSL https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -o tf.zip
        sudo unzip -o tf.zip -d /usr/local/bin
        terraform -version
      displayName: "Install Terraform"

    # -------------------------
    # Step 2: Generate tfvars file
    # -------------------------
    - script: |
        echo "Generating terraform.auto.tfvars from pipeline variables"
        cat > terraform/pipeline.auto.tfvars <<EOF
        application_name = "book-review-app"
        environment      = "dev"
        aws_region       = "$(AWS_REGION)"

        vpc_cidr           = "10.0.0.0/16"
        public_subnet_cidr = "10.0.1.0/24"

        # x86_64 AMI for Ubuntu 22.04 in us-east-1
        ami_id        = "ami-08c40ec9ead489470"
        instance_type = "t3.micro"
        key_name      = "$(EC2_KEYPAIR_NAME)"
        EOF

        echo "terraform.auto.tfvars created:"
        cat terraform/pipeline.auto.tfvars
      displayName: 'Generate terraform.auto.tfvars'

    # -------------------------
    # Step 3: Terraform Init
    # -------------------------
    - script: terraform init -input=false
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      displayName: "Terraform Init"

    # -------------------------
    # Step 4: Terraform Apply
    # -------------------------
    - script: terraform apply -input=false -auto-approve -var-file="pipeline.auto.tfvars"
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      displayName: "Terraform Apply"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)

    # -------------------------
    # Step 5: Output useful info
    # -------------------------
    - script: |
        echo "Terraform Outputs:"
        terraform output
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      displayName: "Print Terraform Outputs"
